
BEGIN
    DECLARE v_ton_kho INT;
    DECLARE v_ton_tai_trong_gio INT;
    
    SELECT so_luong_ton INTO v_ton_kho FROM phien_ban_san_pham WHERE id = p_phien_ban_id;
    SELECT id INTO v_ton_tai_trong_gio FROM chi_tiet_gio WHERE gio_hang_id = p_gio_hang_id AND phien_ban_id = p_phien_ban_id;
    
    IF v_ton_kho < p_so_luong_them THEN 
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Số lượng tồn kho không đủ!';
    ELSE 
        IF v_ton_tai_trong_gio IS NOT NULL THEN 
            UPDATE chi_tiet_gio SET so_luong = so_luong + p_so_luong_them WHERE id = v_ton_tai_trong_gio;
        ELSE 
            INSERT INTO chi_tiet_gio (gio_hang_id, phien_ban_id, so_luong) VALUES (p_gio_hang_id, p_phien_ban_id, p_so_luong_them);
        END IF;
    END IF;
END